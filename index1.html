<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tayo Nalang..</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "Poppins", sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #ffd6e7 0%, #ffb6c1 100%);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #8a2b53;
        }

        .container { max-width: 800px; width: 90%; padding: 20px; }

        h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 4rem;
            margin-bottom: 15px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #c44569;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .subtitle { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.8; font-weight: 300; }

        .romantic-border {
            border: 2px solid rgba(255, 182, 193, 0.5);
            border-radius: 20px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        button {
            padding: 15px 40px;
            margin-top: 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(to right, #e84393, #fd79a8);
            color: white;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(232, 67, 147, 0.3);
            position: relative;
            overflow: hidden;
        }

        button:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(232, 67, 147, 0.4); }
        button:active { transform: translateY(0); }

        .hidden { display: none; }

        .cards {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 25px;
            flex-wrap: nowrap; /* Ensures cards don't wrap */
            position: relative; 
        }

        .card {
            width: 170px;
            height: 230px;
            flex-shrink: 0;
            perspective: 1000px;
            position: relative;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .card:hover { transform: translateY(-10px); }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner { transform: rotateY(180deg); }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .card-front {
            background: linear-gradient(135deg, #e84393, #fd79a8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .card-front i { margin-bottom: 10px; }
        .card-back { transform: rotateY(180deg); background: white; display: flex; align-items: center; justify-content: center; border: 2px solid #ffb6c1; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }

        #resultText { margin-top: 20px; font-size: 1.5rem; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        .shake { animation: shake 0.5s; }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .tada { animation: tada 1s; }

        .floating-element { position: fixed; animation: float 8s linear infinite; opacity: 0.7; z-index: 0; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0.7; } 100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; } }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 182, 193, 0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #e84393, #fd79a8);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .attempt-counter { font-size: 1rem; margin-bottom: 10px; opacity: 0.8; }

        .final-image {
            width: 250px; height: 300px; object-fit: cover; border-radius: 15px;
            margin: 20px 0; box-shadow: 0 15px 30px rgba(0,0,0,0.2); border: 3px solid white; animation: tada 2s;
        }

        .final-video {
            width: 300px; max-width: 90%; border-radius: 15px; margin: 20px 0; box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .confetti { position: fixed; width: 10px; height: 10px; background: #e84393; animation: confetti-fall 5s linear infinite; z-index: 1000; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

        .romantic-message { font-family: 'Dancing Script', cursive; font-size: 1.8rem; margin: 20px 0; color: #c44569; }
        .love-icon { font-size: 2rem; margin: 0 10px; color: #e84393; }
        .shuffle-indicator { font-size: 1.2rem; margin: 15px 0; color: #e84393; font-weight: 500; opacity: 0; transition: opacity 0.5s; }
        .final-button { margin-top: 10px; } /* Style for the new buttons */

        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            
            /* Mobile Layout Fix: Make the romantic-border box slightly bigger */
            .romantic-border { padding: 15px; } 

            .cards { 
                gap: 2vw;
                justify-content: center;
            }
            
            /* Mobile Layout Fix: Make the cards smaller using vw units for responsiveness */
            .card { 
                width: 28vw; 
                height: 40vw; 
            } 
            
            .final-image { width: 200px; height: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>May iba ka.</h1>
        <p class="subtitle">San dito sa tatlo?</p>

        <div id="startScreen">
            <div class="romantic-border">
                <p class="romantic-message">Ayusin mo sagot mo.</p>
                <button id="playBtn"><i class="fas fa-heart" style="margin-right: 8px;"></i> Pumili ng kabit</button>
            </div>
        </div>

        <div id="game" class="hidden">
            <div class="romantic-border">
                <h2>Kabit well</h2>
                <p class="attempt-counter" id="attemptCounter">Kabit ni jecel: 0</p>
                <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
                <p class="shuffle-indicator" id="shuffleIndicator">Hindi mo na ako mahal?</p>
                <div class="cards" id="cardContainer"></div>
            </div>
        </div>

        <div id="result" class="hidden">
            <div class="romantic-border">
                <h2 id="resultText"></h2>
                <img id="wrongImg" src="" class="hidden final-image"><br>
                <button id="retryBtn" class="hidden"><i class="fas fa-redo" style="margin-right: 8px;"></i> Try Again</button>
            </div>
        </div>

        <div id="final" class="hidden">
            <div class="romantic-border">
                <h2 class="romantic-message">Yiee kilig betlog ko beh</h2>
                <i class="fas fa-heart love-icon"></i><i class="fas fa-heart love-icon"></i><i class="fas fa-heart love-icon"></i>
                
                <div id="finalStep1">
                    <img src="1.jpeg" alt="True Love" class="final-image">
                    <br>
                    <button id="nextToVideoBtn" class="final-button"><i class="fas fa-gift" style="margin-right: 8px;"></i> Surprise</button>
                </div>

                <div id="finalStep2" class="hidden">
                    <video src="1.mp4" controls autoplay class="final-video"></video>
                    <br>
                    <button id="goToBookBtn" class="final-button"><i class="fas fa-book-open" style="margin-right: 8px;"></i> Kiss</button>
                </div>
                
                <button id="playAgainBtn" class="hidden"><i class="fas fa-play" style="margin-right: 8px;"></i> Play Again</button>
            </div>
        </div>
        </div>
    
    <audio id="backgroundAudio" src="x.mp3" loop></audio>

    <script>
        const playBtn = document.getElementById("playBtn");
        const game = document.getElementById("game");
        const cardContainer = document.getElementById("cardContainer");
        const result = document.getElementById("result");
        const resultText = document.getElementById("resultText");
        const retryBtn = document.getElementById("retryBtn");
        const final = document.getElementById("final");
        const wrongImg = document.getElementById("wrongImg");
        const progressBar = document.getElementById("progressBar");
        const attemptCounter = document.getElementById("attemptCounter");
        const playAgainBtn = document.getElementById("playAgainBtn");
        const startScreen = document.getElementById("startScreen");
        const shuffleIndicator = document.getElementById("shuffleIndicator");

        // NEW ELEMENTS
        const nextToVideoBtn = document.getElementById("nextToVideoBtn");
        const goToBookBtn = document.getElementById("goToBookBtn");
        const finalStep1 = document.getElementById("finalStep1");
        const finalStep2 = document.getElementById("finalStep2");
        const backgroundAudio = document.getElementById("backgroundAudio");
        // END NEW ELEMENTS

        const images = ["1.jpeg", "2.jpeg", "3.jpeg"];
        const correctImg = "1.jpeg";
        let attempts = 0;

        function loadCards() {
            cardContainer.innerHTML = "";
            // Ensure the images are shuffled for a new game
            const shuffledImages = [...images].sort(() => Math.random() - 0.5); 
            shuffledImages.forEach((img) => {
                const card = document.createElement("div");
                card.className = "card";
                card.dataset.img = img;
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front"><i class="fas fa-heart"></i><span>Kabit?</span></div>
                        <div class="card-back"><img src="${img}" alt="Potential love"></div>
                    </div>`;
                cardContainer.appendChild(card);
            });
        }

        /**
         * Smooth, non-overlapping card shuffling animation.
         */
        function startShuffle() {
            // Clean up previous game state and disable interaction
            document.querySelectorAll(".card").forEach(card => {
                card.classList.remove('tada', 'shake');
                if (card.listener) card.removeEventListener("click", card.listener);
            });
            let cards = [...document.querySelectorAll(".card")];
            cards.forEach(card => card.classList.add("flipped"));
            shuffleIndicator.style.opacity = "1";
            cardContainer.style.pointerEvents = "none"; // Disable clicks during shuffle

            let shuffleCount = (attempts < 2) ? 8 : 4; 
            let transitionDuration = 600; // Match CSS transition time
            let intervalTime = (attempts < 2) ? 600 : 900; 
            
            // Delay before starting the shuffle routine to let the initial flip animation fully settle.
            setTimeout(() => {
                cards.forEach(card => card.classList.remove("flipped"));
                setTimeout(performShuffle, 500); // 500ms delay for stability
            }, 800);

            // Function to handle the animated swap
            const animateSwap = (cardA, cardB, callback) => {
                const rectA = cardA.getBoundingClientRect();
                const rectB = cardB.getBoundingClientRect();
                const dx = rectB.left - rectA.left;
                const dy = rectB.top - rectA.top;

                [cardA, cardB].forEach(card => {
                    card.style.transition = `transform ${transitionDuration}ms ease-in-out`;
                });

                cardA.style.transform = `translate(${dx}px, ${dy}px)`;
                cardB.style.transform = `translate(${-dx}px, ${-dy}px)`;

                // Wait for the transition to finish before updating DOM
                cardA.addEventListener('transitionend', function handler() {
                    cardA.removeEventListener('transitionend', handler);

                    // Reset transforms
                    cardA.style.transform = "";
                    cardB.style.transform = "";
                    cardA.style.transition = "";
                    cardB.style.transition = "";

                    // Perform the actual DOM swap
                    const parent = cardContainer;
                    const temp = document.createElement('div');
                    parent.insertBefore(temp, cardA);
                    parent.insertBefore(cardA, cardB);
                    parent.insertBefore(cardB, temp);
                    parent.removeChild(temp);

                    // Update the 'cards' array to reflect the new DOM order
                    cards = [...document.querySelectorAll(".card")];
                    callback(); // Proceed to the next step
                }, { once: true });
            };

            // The actual shuffle logic loop
            function performShuffle() {
                let i = 0;
                shuffleIndicator.textContent = "Mga babae talaga.";
                
                const shuffleStep = () => {
                    if (i >= shuffleCount) {
                        // End of shuffle
                        shuffleIndicator.textContent = "Umayos ka.";
                        cardContainer.style.pointerEvents = "auto";
                        setTimeout(() => {
                            shuffleIndicator.style.opacity = "0";
                            setTimeout(() => { shuffleIndicator.textContent = "Ios ios may kabit."; }, 1000);
                        }, 2000);
                        enableGuess();
                        return;
                    }

                    let a = Math.floor(Math.random() * cards.length);
                    let b = Math.floor(Math.random() * cards.length);
                    while (a === b) b = Math.floor(Math.random() * cards.length);

                    const cardA = cards[a];
                    const cardB = cards[b];

                    animateSwap(cardA, cardB, () => {
                        i++;
                        setTimeout(shuffleStep, intervalTime - transitionDuration); 
                    });
                };

                shuffleStep();
            }
        }

        function enableGuess() {
            document.querySelectorAll(".card").forEach(card => {
                const clickHandler = () => handleChoice(card.dataset.img);
                card.listener = clickHandler; 
                card.addEventListener("click", clickHandler, { once: true });
            });
        }

        function handleChoice(chosen) {
            attempts++;
            progressBar.style.width = `${(attempts / 3) * 100}%`;
            attemptCounter.textContent = `Kabit ni jecel: ${attempts}`;

            // This section must run first to visually mark the chosen card
            document.querySelectorAll(".card").forEach(card => {
                card.removeEventListener("click", card.listener); 
                if (card.dataset.img === chosen) {
                    card.classList.add('tada');
                    card.classList.add("flipped"); // Flip the chosen card immediately
                } else {
                    card.classList.add('shake');
                }
            });

            setTimeout(() => {
                game.classList.add("hidden");
                
                // GAME LOGIC
                const isCorrectChoice = chosen === correctImg;
                const canWin = attempts >= 3;

                if (isCorrectChoice && canWin) {
                    // SUCCESS - NEW LOGIC
                    result.classList.add("hidden");
                    final.classList.remove("hidden");

                    // ðŸ’– AUDIO FIX: Stop x.mp3 and start y.mp3
                    backgroundAudio.pause();
                    backgroundAudio.src = "y.mp3"; // Change source
                    backgroundAudio.load();        // Load the new file
                    backgroundAudio.loop = true;   // Ensure it loops
                    backgroundAudio.play().catch(e => console.log('Failed to play y.mp3'));
                    // -----------------------------
                    
                    // Start at step 1: show image and first next button
                    finalStep1.classList.remove("hidden");
                    finalStep2.classList.add("hidden"); // Ensure video part is hidden
                    playAgainBtn.classList.add("hidden"); // Hide the original Play Again button
                    
                    createConfetti();
                } else {
                    // FAILURE or FORCED FAILURE
                    result.classList.add("hidden");
                    result.classList.remove("hidden");
                    retryBtn.classList.remove("hidden");
                    wrongImg.classList.remove("hidden");

                    let imageToShowOnResultScreen = chosen;
                    
                    if (isCorrectChoice && !canWin) {
                        // FORCED FAILURE LOGIC: Right card chosen, but too early.
                        resultText.textContent = "San ba ako nag kulang ðŸ’”";
                        
                        // Get the two images that are NOT the correct one.
                        const wrongOptions = images.filter(img => img !== correctImg);
                        
                        // Randomly select one of the two wrong images (2.jpeg or 3.jpeg)
                        const randomIndex = Math.floor(Math.random() * wrongOptions.length);
                        imageToShowOnResultScreen = wrongOptions[randomIndex]; 

                    } else {
                        // GENUINE FAILURE: They picked a wrong card.
                        resultText.textContent = "Basta pogi talaga eh ðŸ’”";
                        imageToShowOnResultScreen = chosen; // Show the wrong card they actually picked
                    }

                    // Display the determined image on the result screen
                    wrongImg.src = imageToShowOnResultScreen; 
                }
            }, 1000);
        }

        // --- Event Listeners ---

        // Audio Autoplay Attempt (May be blocked by browsers)
        backgroundAudio.play().catch(error => {
            console.log('Autoplay blocked. Linking audio start to play button.');
        });

        playBtn.addEventListener("click", () => { 
            startScreen.classList.add("hidden"); 
            game.classList.remove("hidden"); 
            loadCards(); 
            startShuffle(); 
            // Manual play if autoplay was blocked
            backgroundAudio.play().catch(e => console.log('Audio manually started.'));
        });
        
        retryBtn.addEventListener("click", () => { 
            wrongImg.classList.add("hidden"); 
            retryBtn.classList.add("hidden"); 
            result.classList.add("hidden"); 
            game.classList.remove("hidden"); 
            loadCards(); 
            startShuffle(); 
        });

        // NEW: Listener for the first "Next" button (shows the video)
        nextToVideoBtn.addEventListener("click", () => { 
            finalStep1.classList.add("hidden");
            finalStep2.classList.remove("hidden");
            // Autoplay attribute is on the video, so it starts automatically
        });

        // NEW: Listener for the second "Next" button (redirects)
        goToBookBtn.addEventListener("click", () => {
            // Redirects the user to book.html
            window.location.href = "book.html"; 
        });

        // Original Play Again button (kept in case it's used elsewhere, but hidden in the new win flow)
        playAgainBtn.addEventListener("click", () => { 
            final.classList.add("hidden"); 
            game.classList.remove("hidden"); 
            attempts = 0; 
            progressBar.style.width = "0%"; 
            attemptCounter.textContent = "Attempts: 0"; 
            loadCards(); 
            startShuffle(); 
        });

        // --- Background/Aesthetic Functions ---

        function createRomanticElement() {
            const el = document.createElement("div");
            el.className = "floating-element";
            el.style.left = Math.random() * 100 + "vw";
            el.style.fontSize = (Math.random() * 20 + 15) + "px";
            el.style.animationDuration = (Math.random() * 5 + 5) + "s";
            const emojis = ["ðŸ’–", "ðŸ’•", "ðŸŒ¸", "ðŸ’˜", "ðŸ’", "ðŸŒ¹"];
            el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            el.style.color = ["#e84393","#fd79a8","#ffb6c1","#c44569","#ff9ff3"][Math.floor(Math.random()*5)];
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 10000);
        }
        setInterval(createRomanticElement, 500);

        function createConfetti() {
            for (let i = 0; i < 150; i++) {
                setTimeout(() => {
                    const c = document.createElement("div");
                    c.className = "confetti";
                    c.style.left = Math.random() * 100 + "vw";
                    c.style.backgroundColor = ["#e84393","#fd79a8","#ffb6c1","#c44569","#ff9ff3"][Math.floor(Math.random()*5)];
                    c.style.width = Math.random() * 10 + 5 + "px";
                    c.style.height = Math.random() * 10 + 5 + "px";
                    c.style.animationDuration = Math.random() * 3 + 2 + "s";
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 5000);
                }, i * 30);
            }
        }
    </script>
</body>
</html>

